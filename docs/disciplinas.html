<!DOCTYPE html>
<html>
<head>
    <title>Disciplinas</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
</head>

<body>
<input type="button" value="Refresh" onclick="update()">


<span id="saida"></span>

<script id="disciplina-template" type="text/x-handlebars-template">
    <article class="disciplina">
        <div class="disciplina-rotulo">Nome</div>
        <div class="disciplina-nome">
            {{dados.descricao}}<br>
        </div>
        <div class="disciplina-detalhe">
            ({{dados.id}} {{dados.ch}} horas &nbsp;&nbsp;{{dados.sem}}.&ordm;
            semestre, pág. {{dados.pag}}, núcleo {{#is
            dados.nc "S"}}comum{{else}}específico{{/is}}, {{dados.eixo}}, {{#if
            dados.obr}}obrigatória{{else}}opcional{{/if}})
        </div>

        <div class="disciplina-rotulo">Ementa</div>
        <div class="disciplina-ementa">
            <ul>
                {{#each ementa}}
                <li>{{this}}</li>
                {{/each}}
            </ul>
        </div>

        <div class="disciplina-rotulo">Condições mínimas</div>
        <div class="disciplina__condicoes">
            <ul>
                {{#is dados.nc "S"}}
                <span>Não definidas para disciplinas do núcleo comum.</span>
                {{else}} {{#each condicoes}}
                <li>{{this}}</li>
                {{/each}} {{/is}}
            </ul>
        </div>

        <div class="disciplina-rotulo">Bibliografia</div>
        <div class="disciplina__bibliografia">
            <ul>
                {{#each bibliografias}}
                <li>{{this}}</li>
                {{/each}}
            </ul>
        </div>
    </article>
</script>

<script>
    var baseDados;
    var nos;
    var arestas;
    var disciplinas;
    var template;

    /**
     * A ementa é união dos nós de destino que partem de uma
     * disciplina e são do tipo 3.
     * @param id O identificador único da disciplina.
     * @param dados Base de dados contendo as arestas.
     * @returns {Array} Sequência dos componentes da ementa.
     */
    function ementa(id, dados) {
        var arestas = dados.links;
        var conteudos = new Set();
        arestas.forEach(function (i) {
            if (i.tipo === 3 && i.source === id) {
                conteudos.add(i.target);
            }
        });

        var descricoes = [];
        dados.nodes.forEach(function (n) {
            if (conteudos.has(n.id)) {
                descricoes.push(n.descricao);
            }
        });

        return descricoes;
    }

    function condicoesMinimas(id, dados) {
        var arestas = dados.links;
        var conteudos = new Set();
        arestas.forEach(function (i) {
            if (i.tipo === 2 && i.source === id) {
                conteudos.add(i.target);
            }
        });

        var condicoes = [];
        dados.nodes.forEach(function (n) {
            if (conteudos.has(n.id)) {
                condicoes.push(n.descricao);
            }
        });
        return condicoes;
    }

    function update() {
        let html = "";
        let id;
        for (var idx = 0; idx < 44; idx++) {
            id = disciplinas[idx].id;
            var disciplina = {
                dados: disciplinas[idx],
                ementa: ementa(id, baseDados),
                condicoes: condicoesMinimas(id, baseDados)
            };

            html = html + template(disciplina);
        }

        const saida = document.getElementById('saida');
        saida.innerHTML = html;
    }

    function exibe() {
        var source = document.getElementById('disciplina-template').innerHTML;

        template = Handlebars.compile(source);

        update();
    }

    Handlebars.registerHelper('is', function(a, b, opts) {
        if(a == b) {
            return opts.fn(this);
        } else {
            return opts.inverse(this);
        }
    });

    fetch("d3.json")
        .then(function (d) {
            return d.json();
        })
        .then(function (d) {
            baseDados = d;
        })
        .then(function () {
            return fetch("data/disciplinas.json");
        })
        .then(function (d) {
            return d.json();
        })
        .then(function (d) {
            disciplinas = d;
        })
        .then(exibe);
</script>

</body>
</html>